// connect to server like normal
// var dispatcher = new WebSocketRails(window.location.host);

var pusher;

$(function() {
  pusher = new Pusher('c45d65e611bfd1c39e44');
  loadYouTubePlayer();
});

function loadYouTubePlayer() {
  var params = { allowScriptAccess: "always" };
  var atts = { id: "ytplayer" };
  // change this url later, it's pointing to a kanye west video
  var url = "http://www.youtube.com/v/x36nVPJWVdk?enablejsapi=1&playerapiid=ytplayer&version=3";
  swfobject.embedSWF(
    url,
    "ytplayercontainer",
    "425",
    "356",
    "8",
    null,
    null,
    params,
    atts
  );
}

function onYouTubePlayerReady(playerId) {
  ytplayer = document.getElementById("ytplayer");
  ytplayer.addEventListener("onStateChange", "onYouTubePlayerStateChange");

  var playlistId = $.cookie('current_playlist_id');
  var channel = pusher.subscribe(playlistId);

  channel.bind('track_added', function(data) {
    console.log('track added');
    playerState = ytplayer.getPlayerState();
    if (playerState === -1 || playerState === 0) {
      console.log('loading next track since state was unstarted')
      loadNextTrack();
    }
  });

  channel.bind('play_next_track_now', function(data) {
    console.log('playing next track now');
    loadNextTrack();
  });

  loadNextTrack();
}


function loadNextTrack() {
  var playlistId = $.cookie('current_playlist_id');
  var urlStr = '/playlists/' + playlistId + '/next_track';

  $.ajax({
    url: urlStr
  }).done(function(response) {
    console.log('received next track');
    ytplayer = document.getElementById("ytplayer");
    ytplayer.loadVideoById(response['next_track_id']);
  });
}

function onYouTubePlayerStateChange(newState) {
  console.log("player state: " + newState)
  if (newState === 0) {
    loadNextTrack();
  }
}

